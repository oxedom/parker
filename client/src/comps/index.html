<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parker</title>
</head>
<body>

  <div id="canvasWrapper" style="position: relative;">
    <canvas id="overlay"  style="position: absolute;"></canvas>
    <canvas id="canvas"  style="position: absolute; border: 1px solid red; background-color: transparent;"> </canvas>
    <canvas id="input-canvas" style="position: absolute; z-index: -1;" ></canvas>
    
    <video oncontextmenu="return false" id="input" style="visibility: hidden;"></video>
   </div>
    

<img id="output"/>
</body>
<script>

//API FOR FLASK URL
// const flask_url = 'https://www.sam-brink.com/cv/yolo'

var input_imageCapture;




function onTakePhotoButtonClick() {
  input_imageCapture.takePhoto()
  .then(blob => createImageBitmap(blob))
  .then(imageBitmap => {
    const canvas = document.querySelector('#input-canvas');
    drawCanvas(canvas, imageBitmap);
  })
  .catch(error => ChromeSamples.log(error));
}

/* Utils */

function drawCanvas(canvas, img) {
  canvas.width = getComputedStyle(canvas).width.split('px')[0];
  canvas.height = getComputedStyle(canvas).height.split('px')[0];
  let ratio  = Math.min(canvas.width / img.width, canvas.height / img.height);
  let x = (canvas.width - img.width * ratio) / 2;
  let y = (canvas.height - img.height * ratio) / 2;
  canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
  canvas.getContext('2d').drawImage(img, 0, 0, img.width, img.height,
      x, y, img.width * ratio, img.height * ratio);
}

// document.querySelector('video').addEventListener('play', function() {
//   document.querySelector('#grabFrameButton').disabled = false;
//   document.querySelector('#takePhotoButton').disabled = false;
// });





const getVideo = () => {
    navigator.mediaDevices
      .getUserMedia({ video: { width: 720 } })
      .then((stream) => {
        //Gets the current screen
        let video = document.getElementById('input')
        //Sets the Src of video Object
        video.srcObject = stream
        //Plays the video
        video.play()

        //Interval that captures image from Steam, converts to array buffer and 
        //sends it to API as a bufferArray, waiting for response and sets the base64 to 
        //the image SRC on output
        setInterval(async () => {
          const track = stream.getVideoTracks()[0];
          let imageCapture = new ImageCapture(track);
          input_imageCapture = imageCapture;
          const capturedImage = await imageCapture.takePhoto();
          
          let imageBuffer = await capturedImage.arrayBuffer();
          imageBuffer = new Uint8Array(imageBuffer);
          onTakePhotoButtonClick()

            // const res = await fetch(flask_url, {
            //                     method: 'POST',
            //                     headers: {'Content-Type': 'application/json'},
            //                     body: (JSON.stringify({buffer: [...imageBuffer]}))
            //                     })
                
            // const output = document.getElementById('output')
            // const resJson = await res.json()
        
            // output.src = resJson.img
      
        }, 1000);
      })


      .catch((err) => {
        console.error("error:", err);
      }); }


    getVideo()
   

</script>
<script src="draw.js"></script>
</html>

